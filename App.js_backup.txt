import React, { useState, useRef, useEffect } from 'react';
import { 
  StyleSheet, Text, View, ScrollView, SafeAreaView, Alert, 
  TouchableOpacity, TextInput, Switch, Modal, KeyboardAvoidingView, 
  Platform, Animated, Dimensions, ActivityIndicator, Image, Share, FlatList 
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { BlurView } from 'expo-blur';
import * as Location from 'expo-location'; 
import * as ImagePicker from 'expo-image-picker';
import * as Device from 'expo-device';
import * as Notifications from 'expo-notifications';
import Constants from 'expo-constants';
import LiveMap from './components/LiveMap'; 
import * as Linking from 'expo-linking';
import AsyncStorage from '@react-native-async-storage/async-storage';

// --- FIREBASE IMPORTS ---
import { initializeApp, getApps, getApp } from "firebase/app";
import { 
  getAuth, 
  initializeAuth, 
  getReactNativePersistence, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendPasswordResetEmail,    
  onAuthStateChanged, 
  signOut 
} from "firebase/auth";
import { 
  getFirestore, collection, addDoc, query, where, onSnapshot, 
  orderBy, setDoc, doc, updateDoc, deleteDoc, arrayUnion, 
  getDoc, getDocs 
} from "firebase/firestore";
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";

const { width } = Dimensions.get('window');

// ---------------------------------------------------------
// üö® EXPO PROJECT ID üö®
// ---------------------------------------------------------
const HARDCODED_EXPO_PROJECT_ID = "56885664-e8b2-4b0e-abc8-dc75aa3bb608"; 

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCdn4SBQI7HuqEJ7-le4eKF66byXxAlHRM",
  authDomain: "stride4stride-78d80.firebaseapp.com",
  projectId: "stride4stride-78d80",
  storageBucket: "stride4stride-78d80.firebasestorage.app",
  messagingSenderId: "717185252830",
  appId: "1:717185252830:web:825f4a3adb9dc0ed7a714f"
};

// --- FIREBASE INITIALIZATION ---
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();

let auth;
try {
  auth = getAuth(app);
} catch (e) {
  auth = initializeAuth(app, {
    persistence: getReactNativePersistence(AsyncStorage),
  });
}

const db = getFirestore(app);
const storage = getStorage(app);


// --- NOTIFICATION SETUP ---
if (Platform.OS !== 'web') {
  Notifications.setNotificationHandler({
    handleNotification: async () => ({ shouldShowAlert: true, shouldPlaySound: true, shouldSetBadge: false }),
  });
}

async function registerForPushNotificationsAsync() {
  if (Platform.OS === 'web') return;
  if (Platform.OS === 'android') {
    await Notifications.setNotificationChannelAsync('default', { name: 'default', importance: Notifications.AndroidImportance.MAX, vibrationPattern: [0, 250, 250, 250], lightColor: '#FF231F7C' });
  }
  if (Device.isDevice) {
    const { status: existingStatus } = await Notifications.getPermissionsAsync();
    let finalStatus = existingStatus;
    if (existingStatus !== 'granted') {
      const { status } = await Notifications.requestPermissionsAsync();
      finalStatus = status;
    }
    if (finalStatus !== 'granted') {
        Alert.alert("Permission Required", "Please enable Push Notifications in settings to receive chat updates.");
        return;
    }
    
    // --- ROBUST TOKEN GENERATION ---
    try {
        const projectId = HARDCODED_EXPO_PROJECT_ID || Constants.expoConfig?.extra?.eas?.projectId || Constants.easConfig?.projectId;
        if (!projectId) return null; 

        const tokenData = await Notifications.getExpoPushTokenAsync({ projectId });
        return tokenData.data;
    } catch (e) { 
        console.log("Push Token Error:", e.message);
        return null;
    }
  } else {
      console.log("Must use physical device for Push Notifications");
  }
}

// --- SHARED HELPER: SEND NOTIFICATIONS ---
const sendPushNotification = async (tokens, title, body, data) => {
    if (!tokens || tokens.length === 0) return;
    
    // Deduplicate tokens
    const uniqueTokens = [...new Set(tokens)];

    const chunks = [];
    for (let i = 0; i < uniqueTokens.length; i += 100) {
        chunks.push(uniqueTokens.slice(i, i + 100));
    }

    for (let chunk of chunks) {
        try {
            await fetch('https://exp.host/--/api/v2/push/send', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Accept-encoding': 'gzip, deflate',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: chunk,
                    title: title,
                    body: body,
                    data: data,
                    sound: 'default'
                }),
            });
        } catch (e) {
            console.log("Push Network Error", e);
        }
    }
};

// --- SHARED COMPONENTS ---
const GlassCard = ({ children, style }) => (
  <View style={styles.cardWrapper}>
    <BlurView intensity={30} tint="dark" style={[styles.glass, style]}>{children}</BlurView>
  </View>
);
const UserAvatar = ({ url, size = 50, style }) => (
    <Image source={url ? { uri: url } : { uri: "https://ui-avatars.com/api/?name=Runner&background=random&color=fff" }} style={[{ width: size, height: size, borderRadius: size / 2, backgroundColor: '#333' }, style]} />
);
const Toast = ({ message, visible, onHide }) => {
  const opacity = useRef(new Animated.Value(0)).current;
  useEffect(() => {
    if (visible) {
      Animated.sequence([
        Animated.timing(opacity, { toValue: 1, duration: 300, useNativeDriver: true }),
        Animated.delay(2000),
        Animated.timing(opacity, { toValue: 0, duration: 300, useNativeDriver: true })
      ]).start(() => onHide());
    }
  }, [visible]);
  if (!visible) return null;
  return (
    <Animated.View style={[styles.toastContainer, { opacity }]}>
      <BlurView intensity={90} tint="dark" style={styles.toastGlass}><Text style={styles.toastText}>‚úì {message}</Text></BlurView>
    </Animated.View>
  );
};

// --- RUN TRACKER ---
const RunTrackerScreen = ({ setCurrentScreen, onSaveRun }) => {
  const [location, setLocation] = useState(null);
  const [routeCoordinates, setRouteCoordinates] = useState([]);
  const [distanceTravelled, setDistanceTravelled] = useState(0);
  const [currentPace, setCurrentPace] = useState('--:--');
  const [isTracking, setIsTracking] = useState(false);
  const [timer, setTimer] = useState(0);
  const subscription = useRef(null);
  const timerRef = useRef(null);
  const lastMileInteger = useRef(0); 
  const lastSplitTimestamp = useRef(0); 
  const lastSplitPaceSeconds = useRef(null);

  const formatTime = (totalSeconds) => {
    const mins = Math.floor(totalSeconds / 60);
    const secs = Math.floor(totalSeconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };
  const calculatePaceFromSpeed = (speedMs) => {
    if (!speedMs || speedMs < 0.1) return '--:--'; 
    const milesPerSecond = speedMs * 0.000621371;
    const secondsPerMile = 1 / milesPerSecond;
    return formatTime(secondsPerMile);
  };
  const sendMileNotification = async (mileNumber, splitSeconds) => {
    const splitString = formatTime(splitSeconds);
    let trend = "‚û°Ô∏è"; 
    if (lastSplitPaceSeconds.current !== null) {
        if (splitSeconds < lastSplitPaceSeconds.current) trend = "‚¨ÜÔ∏è (Faster)";
        else if (splitSeconds > lastSplitPaceSeconds.current) trend = "‚¨áÔ∏è (Slower)";
    }
    await Notifications.scheduleNotificationAsync({
        content: { title: `üéâ Mile ${mileNumber} Complete!`, body: `Time: ${splitString} \nAvg Pace: ${splitString} /mi ${trend}`, sound: true },
        trigger: null, 
    });
    lastSplitPaceSeconds.current = splitSeconds;
  };
  const toggleTracking = async () => {
    if (isTracking) {
      setIsTracking(false);
      if (subscription.current) subscription.current.remove();
      if (timerRef.current) clearInterval(timerRef.current);
    } else {
      try {
          let { status } = await Location.requestForegroundPermissionsAsync();
          if (status !== 'granted') { 
              Alert.alert("Permission Denied", "Please allow location access in your device settings."); 
              return; 
          }
      } catch (e) {
          Alert.alert("Permission Error", "Could not request location. Please check your device settings.");
          return;
      }

      setIsTracking(true);
      setRouteCoordinates([]);
      setDistanceTravelled(0);
      setCurrentPace('--:--');
      setTimer(0);
      lastMileInteger.current = 0;
      lastSplitTimestamp.current = 0;
      lastSplitPaceSeconds.current = null;
      timerRef.current = setInterval(() => setTimer(t => t + 1), 1000);
      subscription.current = await Location.watchPositionAsync(
        { accuracy: Location.Accuracy.High, timeInterval: 1000, distanceInterval: 1 },
        (newLoc) => {
          const { latitude, longitude, speed } = newLoc.coords;
          const newPoint = { latitude, longitude };
          setLocation({ latitude, longitude, latitudeDelta: 0.005, longitudeDelta: 0.005 });
          setCurrentPace(calculatePaceFromSpeed(speed));
          setRouteCoordinates(prev => {
            const newRoute = [...prev, newPoint];
            if (prev.length > 0) {
              const last = prev[prev.length - 1];
              const distToAdd = calcDistance(last.latitude, last.longitude, latitude, longitude);
              setDistanceTravelled(prevDist => prevDist + distToAdd);
            }
            return newRoute;
          });
        }
      );
    }
  };
  useEffect(() => {
      if (!isTracking) return;
      const mileInt = Math.floor(distanceTravelled);
      if (mileInt > lastMileInteger.current) {
          const now = timer;
          const durationOfThisMile = now - lastSplitTimestamp.current;
          sendMileNotification(mileInt, durationOfThisMile);
          lastMileInteger.current = mileInt;
          lastSplitTimestamp.current = now;
      }
  }, [distanceTravelled]);
  const calcDistance = (lat1, lon1, lat2, lon2) => {
    const R = 3958.8; 
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  };
  const handleFinish = () => {
    if(distanceTravelled > 0) {
      Alert.alert("Run Finished", `You ran ${distanceTravelled.toFixed(2)} miles!`, [
          { text: "Save Run", onPress: () => {
              onSaveRun({
                  distance: parseFloat(distanceTravelled.toFixed(2)),
                  date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                  shoe: 'None', 
                  shoeId: null,
                  isGps: true, 
                  club: null,
                  routeCoordinates: routeCoordinates
              });
              setCurrentScreen('History');
          }}
      ]);
    } else { setIsTracking(false); setCurrentScreen('Home'); }
  };
  return (
    <View style={{flex: 1, backgroundColor: 'black'}}>
      <LiveMap location={location} routeCoordinates={routeCoordinates} />
      <SafeAreaView style={{flex: 1, justifyContent: 'space-between', padding: 20}}>
        <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 15}}>
            <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={{backgroundColor: 'rgba(0,0,0,0.6)', padding: 10, borderRadius: 20}}><Text style={{color: 'white', fontWeight: 'bold'}}>‚úñ Close</Text></TouchableOpacity>
            <View style={{backgroundColor: 'rgba(239,68,68,0.9)', paddingHorizontal: 20, paddingVertical: 5, borderRadius: 15, justifyContent: 'center', alignItems: 'center'}}><Text style={{color: 'white', fontWeight: '900', textAlign: 'center'}}>LIVE GPS</Text></View>
        </View>
        <GlassCard style={{paddingVertical: 30}}>
            <View style={{flexDirection: 'row', justifyContent: 'space-around', marginBottom: 20}}>
                <View style={{alignItems: 'center'}}><Text style={{color: 'rgba(255,255,255,0.5)', fontSize: 12, fontWeight: '900'}}>DISTANCE</Text><Text style={{color: 'white', fontSize: 42, fontWeight: '900'}}>{distanceTravelled.toFixed(2)}</Text><Text style={{color: 'white', fontSize: 14}}>MILES</Text></View>
                <View style={{alignItems: 'center'}}><Text style={{color: 'rgba(255,255,255,0.5)', fontSize: 12, fontWeight: '900'}}>TIME</Text><Text style={{color: 'white', fontSize: 42, fontWeight: '900'}}>{formatTime(timer)}</Text><Text style={{color: 'white', fontSize: 14}}>MM:SS</Text></View>
            </View>
            <View style={{alignItems: 'center', marginBottom: 30}}><Text style={{color: '#3b82f6', fontSize: 12, fontWeight: '900', letterSpacing: 1}}>CURRENT PACE</Text><Text style={{color: 'white', fontSize: 32, fontWeight: '900'}}>{currentPace} <Text style={{fontSize: 14, fontWeight:'400'}}>/mi</Text></Text></View>
            <TouchableOpacity style={{backgroundColor: isTracking ? '#ef4444' : '#22c55e', paddingVertical: 20, borderRadius: 20, alignItems: 'center', marginBottom: 10}} onPress={toggleTracking}><Text style={{color: 'white', fontSize: 22, fontWeight: '900', letterSpacing: 1}}>{isTracking ? "STOP RUN" : "START RUN"}</Text></TouchableOpacity>
            {!isTracking && distanceTravelled > 0 && <TouchableOpacity onPress={handleFinish} style={{alignItems: 'center', padding: 10}}><Text style={{color: '#3b82f6', fontWeight: 'bold', fontSize: 16}}>Finish & Save</Text></TouchableOpacity>}
        </GlassCard>
      </SafeAreaView>
    </View>
  );
};

// --- LOG PAGE ---
const LogPage = ({ setCurrentScreen, shoes, onSaveRun, clubs }) => {
  const [distance, setDistance] = useState('');
  const [selectedDate, setSelectedDate] = useState('Jan 27, 2026');
  const [selectedShoe, setSelectedShoe] = useState(null);
  const [selectedClub, setSelectedClub] = useState('None');
  const [showCalendar, setShowCalendar] = useState(false);
  const [showShoePicker, setShowShoePicker] = useState(false);
  const [showClubPicker, setShowClubPicker] = useState(false);
  
  const activeShoes = shoes.filter(s => !s.retired);
  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  const [viewDate, setViewDate] = useState(new Date()); 
  const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  const getFirstDayOfWeek = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay(); 
  const calendarGrid = [...Array(getFirstDayOfWeek(viewDate)).fill(null), ...Array.from({ length: getDaysInMonth(viewDate) }, (_, i) => i + 1)];
  
  return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
      <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity>
      <Text style={styles.greeting}>Log Run</Text>
      <GlassCard style={{marginTop: 25}}>
        <Text style={styles.label}>DISTANCE (MILES)</Text><TextInput style={styles.input} keyboardType="numeric" value={distance} onChangeText={setDistance} placeholder="0.00" placeholderTextColor="#555"/>
        <Text style={styles.label}>DATE</Text><TouchableOpacity style={[styles.input, {flexDirection:'row', justifyContent:'space-between'}]} onPress={() => setShowCalendar(true)}><Text style={{color:'white', fontWeight:'600'}}>{selectedDate}</Text><Text>üìÖ</Text></TouchableOpacity>
        <Text style={styles.label}>SHOES</Text><TouchableOpacity style={[styles.input, {flexDirection:'row', justifyContent:'space-between'}]} onPress={() => setShowShoePicker(true)}><Text style={{color:'white', fontWeight:'600'}}>{selectedShoe ? selectedShoe.name : 'Select Shoes'}</Text><Text>üëü</Text></TouchableOpacity>
        <Text style={styles.label}>CLUB</Text><TouchableOpacity style={[styles.input, {flexDirection:'row', justifyContent:'space-between'}]} onPress={() => setShowClubPicker(true)}><Text style={{color:'white', fontWeight:'600'}}>{selectedClub}</Text><Text>‚ñº</Text></TouchableOpacity>
        <TouchableOpacity style={[styles.mainActionButton, {marginTop: 20}]} onPress={() => { 
            if(!distance) { Alert.alert("Missing Field", "Please enter the distance."); return; }
            onSaveRun({ 
                distance: parseFloat(distance), 
                date: selectedDate, 
                shoe: selectedShoe?.name || 'Manual',
                shoeId: selectedShoe?.id || null, 
                club: selectedClub === 'None' ? null : selectedClub,
                routeCoordinates: [] 
            }); 
        }}><Text style={styles.buttonText}>Save Run</Text></TouchableOpacity>
      </GlassCard>
      
      <Modal transparent visible={showCalendar} animationType="fade"><View style={styles.modalOverlay}><BlurView intensity={95} tint="dark" style={styles.confirmModal}><View style={{flexDirection: 'row', justifyContent: 'space-between', marginBottom: 15}}><TouchableOpacity onPress={()=>setViewDate(new Date(viewDate.setMonth(viewDate.getMonth()-1)))}><Text style={{color:'white', fontSize:20}}>{'<'}</Text></TouchableOpacity><Text style={{color:'white', fontSize:18}}>{months[viewDate.getMonth()]}</Text><TouchableOpacity onPress={()=>setViewDate(new Date(viewDate.setMonth(viewDate.getMonth()+1)))}><Text style={{color:'white', fontSize:20}}>{'>'}</Text></TouchableOpacity></View><View style={{flexDirection: 'row', flexWrap: 'wrap'}}>{calendarGrid.map((d,i)=><View key={i} style={{width:'14%', aspectRatio:1, alignItems:'center'}}>{d && <TouchableOpacity onPress={()=>{setSelectedDate(`${months[viewDate.getMonth()].substring(0,3)} ${d}, ${viewDate.getFullYear()}`); setShowCalendar(false);}} style={{padding:8}}><Text style={{color:'white'}}>{d}</Text></TouchableOpacity>}</View>)}</View><TouchableOpacity style={[styles.cancelButton, {marginTop:10}]} onPress={()=>setShowCalendar(false)}><Text style={styles.buttonText}>Close</Text></TouchableOpacity></BlurView></View></Modal>
      <Modal transparent visible={showShoePicker} animationType="slide"><View style={styles.bottomSheetOverlay}><BlurView intensity={95} tint="dark" style={styles.bottomSheetContent}><Text style={styles.modalTitle}>Select Shoes</Text>
        <TouchableOpacity style={styles.clubItem} onPress={()=>{setSelectedShoe(null); setShowShoePicker(false);}}><Text style={styles.clubItemText}>None</Text></TouchableOpacity>
        {activeShoes.map(s=><TouchableOpacity key={s.id} style={styles.clubItem} onPress={()=>{setSelectedShoe(s); setShowShoePicker(false);}}><Text style={styles.clubItemText}>{s.name}</Text></TouchableOpacity>)}
        <TouchableOpacity style={styles.cancelButton} onPress={()=>setShowShoePicker(false)}><Text style={styles.buttonText}>Close</Text></TouchableOpacity></BlurView></View></Modal>
      <Modal transparent visible={showClubPicker} animationType="slide"><View style={styles.bottomSheetOverlay}><BlurView intensity={95} tint="dark" style={styles.bottomSheetContent}><Text style={styles.modalTitle}>Select Club</Text>{['None', ...clubs.map(c=>c.name)].map(c=><TouchableOpacity key={c} style={styles.clubItem} onPress={()=>{setSelectedClub(c); setShowClubPicker(false);}}><Text style={styles.clubItemText}>{c}</Text></TouchableOpacity>)}<TouchableOpacity style={styles.cancelButton} onPress={()=>setShowClubPicker(false)}><Text style={styles.buttonText}>Close</Text></TouchableOpacity></BlurView></View></Modal>
    </ScrollView>
  );
};

// --- HISTORY SCREEN ---
const HistoryScreen = ({ setCurrentScreen, runs, shoes, clubs, onDeleteRun, onUpdateRun }) => {
  const [selectedRun, setSelectedRun] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [modalView, setModalView] = useState('form'); 
  const [editDistance, setEditDistance] = useState('');
  const [editDate, setEditDate] = useState('');
  const [editShoe, setEditShoe] = useState(null);
  const [editClub, setEditClub] = useState('None');

  const getRegionForCoordinates = (points) => {
      if (!points || points.length === 0) return null;
      let minLat = points[0].latitude, maxLat = points[0].latitude, minLng = points[0].longitude, maxLng = points[0].longitude;
      points.forEach(p => { minLat = Math.min(minLat, p.latitude); maxLat = Math.max(maxLat, p.latitude); minLng = Math.min(minLng, p.longitude); maxLng = Math.max(maxLng, p.longitude); });
      return { latitude: (minLat+maxLat)/2, longitude: (minLng+maxLng)/2, latitudeDelta: (maxLat-minLat)+0.005, longitudeDelta: (maxLng-minLng)+0.005 };
  };

  const handleEditClick = (run) => {
      setSelectedRun(run); setEditDistance(String(run.distance)); setEditDate(run.date);
      // Logic to find shoe by ID (preferred) or Name (legacy/GPS)
      const shoeObj = shoes.find(s => s.id === run.shoeId) || shoes.find(s => s.name === run.shoe) || (run.shoe !== 'Manual' ? {name: run.shoe} : null);
      setEditShoe(shoeObj); setEditClub(run.club || 'None'); setModalView('form'); setShowModal(true);
  };

  const handleSaveChanges = () => {
      if (!editDistance) { Alert.alert("Missing Field", "Please enter the distance."); return; }
      const updatedData = { 
          distance: parseFloat(editDistance), 
          date: editDate, 
          shoe: editShoe ? editShoe.name : 'Manual',
          shoeId: editShoe ? editShoe.id : null, // --- FIX: Pass ID on Update ---
          club: editClub === 'None' ? null : editClub 
      };
      onUpdateRun(selectedRun.id, updatedData); setShowModal(false);
  };

  const handleDelete = () => {
      Alert.alert("Delete Run?", "This action cannot be undone.", [{ text: "Cancel", style: "cancel" }, { text: "Delete", style: "destructive", onPress: () => { onDeleteRun(selectedRun.id); setShowModal(false); } }]);
  };

  return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
      <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity>
      <Text style={styles.greeting}>History</Text>
      {runs.map((run, i) => (
        <TouchableOpacity key={i} onPress={() => handleEditClick(run)}>
            <GlassCard style={{marginBottom: 10, padding: 15}}>
                <View style={styles.row}>
                    <Text style={styles.valueTitle}>{run.date}</Text>
                    <Text style={{color:'white', fontWeight:'900', fontSize:20}}>{run.distance} mi</Text>
                </View>
                {/* FIX: Show GPS Label based on routeCoordinates OR flag */}
                {(run.routeCoordinates?.length > 0 || run.isGps) && <Text style={{color:'#ef4444', fontSize:10, fontWeight:'bold', marginTop: 5}}>üìç GPS TRACKED</Text>}
                {run.shoe && run.shoe !== 'None' && <Text style={{color:'gray', fontSize:12, marginTop:2}}>üëü {run.shoe}</Text>}
            </GlassCard>
        </TouchableOpacity>
      ))}
      <Modal visible={showModal} transparent animationType="fade">
          <View style={styles.modalOverlay}>
              <BlurView intensity={100} tint="dark" style={[styles.confirmModal, {maxHeight: '90%'}]}>
                  {selectedRun && modalView === 'form' && (
                    <ScrollView>
                        <View style={{flexDirection:'row', justifyContent:'space-between', marginBottom:15}}><Text style={styles.modalTitle}>Edit Run</Text><TouchableOpacity onPress={() => setShowModal(false)}><Text style={{color:'white', fontSize:20}}>‚úï</Text></TouchableOpacity></View>
                        {selectedRun.routeCoordinates && selectedRun.routeCoordinates.length > 0 ? (<View style={{height: 150, borderRadius: 15, overflow: 'hidden', marginBottom: 20, borderWidth: 1, borderColor: 'rgba(255,255,255,0.1)'}}><LiveMap location={getRegionForCoordinates(selectedRun.routeCoordinates)} routeCoordinates={selectedRun.routeCoordinates} scrollEnabled={false} /></View>) : null}
                        <Text style={styles.label}>DISTANCE (MILES)</Text><TextInput style={styles.input} keyboardType="numeric" value={editDistance} onChangeText={setEditDistance} />
                        <Text style={styles.label}>DATE</Text><TextInput style={styles.input} value={editDate} onChangeText={setEditDate} />
                        <Text style={styles.label}>SHOES</Text><TouchableOpacity style={[styles.input, {flexDirection:'row', justifyContent:'space-between'}]} onPress={() => setModalView('shoes')}><Text style={{color:'white', fontWeight:'600'}}>{editShoe ? editShoe.name : 'Select Shoes'}</Text><Text>üëü</Text></TouchableOpacity>
                        <Text style={styles.label}>CLUB</Text><TouchableOpacity style={[styles.input, {flexDirection:'row', justifyContent:'space-between'}]} onPress={() => setModalView('clubs')}><Text style={{color:'white', fontWeight:'600'}}>{editClub}</Text><Text>‚ñº</Text></TouchableOpacity>
                        <View style={{flexDirection:'row', gap:10, marginTop:20}}><TouchableOpacity style={{flex:1, padding:15, backgroundColor:'rgba(255,255,255,0.1)', borderRadius:15, alignItems:'center'}} onPress={handleDelete}><Text style={{color:'#ef4444', fontWeight:'bold'}}>Delete</Text></TouchableOpacity><TouchableOpacity style={{flex:1, padding:15, backgroundColor:'#22c55e', borderRadius:15, alignItems:'center'}} onPress={handleSaveChanges}><Text style={{color:'white', fontWeight:'bold'}}>Save</Text></TouchableOpacity></View>
                    </ScrollView>
                  )}
                  {modalView === 'shoes' && (<ScrollView><Text style={styles.modalTitle}>Select Shoes</Text><TouchableOpacity style={styles.clubItem} onPress={()=>{setEditShoe(null); setModalView('form');}}><Text style={styles.clubItemText}>None</Text></TouchableOpacity>{shoes.filter(s=>!s.retired).map(s=><TouchableOpacity key={s.id} style={styles.clubItem} onPress={()=>{setEditShoe(s); setModalView('form');}}><Text style={styles.clubItemText}>{s.name}</Text></TouchableOpacity>)}<TouchableOpacity style={styles.cancelButton} onPress={()=>setModalView('form')}><Text style={styles.buttonText}>Back</Text></TouchableOpacity></ScrollView>)}
                  {modalView === 'clubs' && (<ScrollView><Text style={styles.modalTitle}>Select Club</Text>{['None', ...clubs.map(c=>c.name)].map(c=><TouchableOpacity key={c} style={styles.clubItem} onPress={()=>{setEditClub(c); setModalView('form');}}><Text style={styles.clubItemText}>{c}</Text></TouchableOpacity>)}<TouchableOpacity style={styles.cancelButton} onPress={()=>setModalView('form')}><Text style={styles.buttonText}>Back</Text></TouchableOpacity></ScrollView>)}
              </BlurView>
          </View>
      </Modal>
    </ScrollView>
  );
};

// --- GEAR TRACKER ---
const ManageShoesScreen = ({ setCurrentScreen, shoes, onAddShoe, onDeleteShoe, onUpdateShoeName }) => {
    const [name, setName] = useState('');
    const [showAddInput, setShowAddInput] = useState(false);
    const [editMode, setEditMode] = useState(null); 
    const [editName, setEditName] = useState('');

    return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
        <View style={{flexDirection:'row', justifyContent:'space-between', alignItems:'center'}}>
            <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}>
                <Text style={styles.backBtnText}>‚Üê Back</Text>
            </TouchableOpacity>
            <TouchableOpacity onPress={() => setShowAddInput(!showAddInput)}>
                <Text style={{fontSize:30, color:'#ef4444'}}>+</Text>
            </TouchableOpacity>
        </View>
        <Text style={styles.greeting}>Gear Tracker</Text>
        
        {showAddInput && (
            <GlassCard>
                <TextInput style={styles.input} placeholder="New Shoe Name" placeholderTextColor="#555" value={name} onChangeText={setName} />
                <TouchableOpacity style={[styles.mainActionButton, {marginTop:10}]} onPress={()=>{if(name){onAddShoe(name); setName(''); setShowAddInput(false);}}}>
                    <Text style={styles.buttonText}>Add Shoe</Text>
                </TouchableOpacity>
            </GlassCard>
        )}
        
        {shoes.map(s => {
            const percent = Math.min(((s.miles || 0) / s.limit) * 100, 100);
            return (
                <GlassCard key={s.id} style={{marginTop:10}}>
                    {editMode === s.id ? (
                        <View>
                            <TextInput style={styles.input} value={editName} onChangeText={setEditName} autoFocus />
                            <View style={{flexDirection:'row', gap:10, marginTop:10}}>
                                <TouchableOpacity style={{flex:1, padding:10, alignItems:'center'}} onPress={()=>setEditMode(null)}>
                                    <Text style={{color:'gray'}}>Cancel</Text>
                                </TouchableOpacity>
                                <TouchableOpacity style={{flex:1, padding:10, alignItems:'center', backgroundColor:'#22c55e', borderRadius:10}} onPress={()=>{onUpdateShoeName(s.id, editName); setEditMode(null);}}>
                                    <Text style={{color:'white', fontWeight:'bold'}}>Save</Text>
                                </TouchableOpacity>
                            </View>
                        </View>
                    ) : (
                        <>
                            <View style={styles.row}>
                                <View style={{flexDirection:'row', alignItems:'center'}}>
                                    <Text style={styles.shoeName}>{s.name}</Text>
                                    <TouchableOpacity onPress={()=>{setEditMode(s.id); setEditName(s.name);}} style={{marginLeft:10}}>
                                        <Text style={{fontSize:16}}>‚úèÔ∏è</Text>
                                    </TouchableOpacity>
                                </View>
                                <TouchableOpacity onPress={()=>onDeleteShoe(s.id)}>
                                    <Text style={{color:'#ef4444'}}>Delete</Text>
                                </TouchableOpacity>
                            </View>
                            <View style={styles.progressBarBase}>
                                <View style={[styles.progressBarFill, { width: `${percent}%`, backgroundColor: percent >= 100 ? '#ef4444' : '#3b82f6' }]} />
                            </View>
                            <Text style={styles.shoeMiles}>{(s.miles || 0).toFixed(1)} / {s.limit} miles</Text>
                        </>
                    )}
                </GlassCard>
            );
        })}
    </ScrollView>
    );
};

// --- PROFILE ---
const ProfileScreen = ({ setCurrentScreen, userProfile, onUpdateUser, onCancelSubscription, onUploadPhoto }) => {
  const [fullName, setFullName] = useState(userProfile.fullName || '');
  const [email, setEmail] = useState(userProfile.email || '');
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [phone, setPhone] = useState(userProfile.phone || '');
  const [shareConsent, setShareConsent] = useState(userProfile.shareConsent ?? true);
  const [isDeleting, setIsDeleting] = useState(false);
  
  const pickImage = async () => {
    try {
      let r = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ['images'],
        allowsEditing: true,
        aspect: [1, 1],
        quality: 0.5
      });
      if (!r.canceled) onUploadPhoto(r.assets[0].uri);
    } catch (e) { Alert.alert("Error", "Could not open gallery."); }
  };

  const handleCancelSubscription = () => {
    setShowConfirmModal(true);
  };

  const confirmCancellation = async () => {
    try {
      setIsDeleting(true); 
      
      const user = auth.currentUser;
      if (!user) {
        setIsDeleting(false);
        return;
      }

      // 1. Delete Subscription Doc
      try {
          await deleteDoc(doc(db, "subscriptions", user.uid));
      } catch (docError) {
          console.log("Subscription doc likely didn't exist, proceeding anyway.");
      }

      // 2. Revoke Founder Status (This triggers the UI updates)
      await updateDoc(doc(db, "users", user.uid), {
        isFounder: false
      });
      
      setIsDeleting(false); 
      setShowConfirmModal(false);
      Alert.alert("Subscription Canceled", "Your premium access has been removed.");
      
    } catch (error) {
      console.log("DELETE ERROR:", error.message);
      setIsDeleting(false); 
      Alert.alert("Error", error.message);
      setShowConfirmModal(false);
    }
  };

  return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
      <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}>
        <Text style={styles.backBtnText}>‚Üê Back</Text>
      </TouchableOpacity>
      <Text style={styles.greeting}>Profile</Text>
      <GlassCard style={{ alignItems: 'center' }}>
        <TouchableOpacity onPress={pickImage}>
          <UserAvatar url={userProfile.photoURL} size={100} />
          <Text style={{ color: '#3b82f6', marginTop: 15 }}>Change Photo</Text>
        </TouchableOpacity>
      </GlassCard>
      <GlassCard style={{ marginTop: 15 }}>
        <Text style={styles.label}>NAME</Text>
        <TextInput style={styles.input} value={fullName} onChangeText={setFullName} />
        <Text style={styles.label}>EMAIL</Text>
        <TextInput style={styles.input} value={email} onChangeText={setEmail} keyboardType="email-address" />
        <Text style={styles.label}>PHONE</Text>
        <TextInput style={styles.input} value={phone} onChangeText={setPhone} />
        <View style={styles.privacyRow}>
          <Text style={styles.valueTitle}>Club Visibility</Text>
          <Switch value={shareConsent} onValueChange={setShareConsent} />
        </View>
        <TouchableOpacity 
          style={[styles.mainActionButton, { marginTop: 20 }]} 
          onPress={() => onUpdateUser({ fullName, email, phone, shareConsent })}
        >
          <Text style={styles.buttonText}>Save Changes</Text>
        </TouchableOpacity>

        {/* --- CONDITIONAL RENDER: Only show Cancel if they are a Founder --- */}
        {userProfile?.isFounder && (
            <TouchableOpacity 
              onPress={handleCancelSubscription}
              style={{ marginTop: 20, padding: 15, borderWidth: 2, borderColor: '#EF4444', borderRadius: 16, alignItems: 'center' }}
            >
              <Text style={{ color: '#EF4444', fontWeight: 'bold' }}>Cancel Subscription</Text>
            </TouchableOpacity>
        )}
      </GlassCard>
	  
      <Modal transparent visible={showConfirmModal} animationType="fade">
        <View style={styles.modalOverlay}>
          <BlurView intensity={100} tint="dark" style={styles.confirmModal}>
            <Text style={styles.modalTitle}>Cancel Subscription?</Text>
            <Text style={[styles.valueDesc, { textAlign: 'center', marginBottom: 25 }]}>
              This will remove your premium access immediately. This action cannot be undone.
            </Text>
            
            <View style={{ flexDirection: 'row', gap: 10 }}>
              <TouchableOpacity 
                style={[styles.secondaryActionButton, { flex: 1 }]} 
                onPress={() => setShowConfirmModal(false)}
              >
                <Text style={styles.buttonText}>Keep It</Text>
              </TouchableOpacity>

              <TouchableOpacity 
                style={[
                  styles.mainActionButton, 
                  { flex: 1, backgroundColor: '#EF4444', opacity: isDeleting ? 0.7 : 1 }
                ]} 
                onPress={confirmCancellation}
                disabled={isDeleting} 
              >
                {isDeleting ? <ActivityIndicator color="white" /> : <Text style={styles.buttonText}>Confirm</Text>}
              </TouchableOpacity>
            </View>
          </BlurView>
        </View>
      </Modal>
    </ScrollView>
  );
};

// --- LOGIN SCREEN ---
const LoginScreen = ({ onLogin, onGoToSignUp }) => { 
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [showResetModal, setShowResetModal] = useState(false);
  const [resetEmail, setResetEmail] = useState('');

  const handleResetPassword = async () => {
    if (!resetEmail) {
      Alert.alert("Error", "Please enter your email address.");
      return;
    }
    try {
      await sendPasswordResetEmail(auth, resetEmail);
      Alert.alert("Success", "Password reset link sent! Check your email.");
      setShowResetModal(false);
    } catch (error) {
      Alert.alert("Error", error.message);
    }
  };

  return (
    <View style={styles.container}>
      <LinearGradient colors={['#000000', '#1e3a8a']} style={styles.background} />
      <KeyboardAvoidingView 
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'} 
        style={{ flex: 1, justifyContent: 'center', padding: 30 }}
      >
        <View style={{ alignItems: 'center', justifyContent: 'center', marginBottom: 40 }}>
          <Image 
            source={require('./assets/images/icon.png')} 
            style={{ width: 180, height: 180, marginBottom: 20 }} 
            resizeMode="contain"
          />
          <Text style={[styles.greeting, { textAlign: 'center', fontSize: 32, marginTop: 0 }]}>
            STRIDE 4 STRIDE
          </Text>
        </View>

        <Text style={[styles.subGreeting, { textAlign: 'center', marginBottom: 30 }]}>
          Sign In
        </Text>

        <GlassCard>
          <Text style={styles.label}>EMAIL ADDRESS</Text>
          <TextInput 
            style={styles.input} 
            placeholder="runner@email.com" 
            placeholderTextColor="#555" 
            value={email} 
            onChangeText={setEmail} 
            keyboardType="email-address" 
            autoCapitalize="none" 
          />
          
          <Text style={styles.label}>PASSWORD</Text>
          <TextInput 
            style={styles.input} 
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
            placeholderTextColor="#555" 
            value={password} 
            onChangeText={setPassword} 
            secureTextEntry
          />

          <TouchableOpacity onPress={() => setShowResetModal(true)} style={{ alignSelf: 'flex-end', marginTop: 10 }}>
            <Text style={{ color: '#3b82f6', fontWeight: 'bold' }}>Forgot Password?</Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={[styles.mainActionButton, { marginTop: 25, backgroundColor: '#22c55e', width: '100%', flex: 0 }]} 
            onPress={async () => {
              setLoading(true);
              try {
                await onLogin(email, password);
              } catch (e) {
                Alert.alert("Login Failed", e.message);
              }
              setLoading(false);
            }}
            disabled={loading}
          >
            {loading ? <ActivityIndicator color="white" /> : <Text style={styles.buttonText}>Log In</Text>}
          </TouchableOpacity>
        </GlassCard>

        <TouchableOpacity style={{marginTop: 30, alignSelf: 'center'}} onPress={onGoToSignUp}>
          <Text style={{color: 'white', opacity: 0.8}}>
            New here? <Text style={{fontWeight: 'bold', color: '#ef4444'}}>Create Profile</Text>
          </Text>
        </TouchableOpacity>
      </KeyboardAvoidingView>

      <Modal transparent visible={showResetModal} animationType="fade">
        <View style={styles.modalOverlay}>
          <BlurView intensity={100} tint="dark" style={styles.confirmModal}>
            <Text style={styles.modalTitle}>Reset Password</Text>
            <Text style={[styles.valueDesc, { textAlign: 'center', marginBottom: 15 }]}>
              Enter your email to receive a reset link.
            </Text>
            <TextInput 
              style={styles.input} 
              placeholder="runner@email.com" 
              placeholderTextColor="#555"
              value={resetEmail}
              onChangeText={setResetEmail}
              autoCapitalize="none"
              keyboardType="email-address"
            />
            <View style={{ flexDirection: 'row', gap: 10, marginTop: 15 }}>
              <TouchableOpacity style={styles.secondaryActionButton} onPress={() => setShowResetModal(false)}>
                <Text style={styles.buttonText}>Cancel</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.mainActionButton} onPress={handleResetPassword}>
                <Text style={styles.buttonText}>Send Link</Text>
              </TouchableOpacity>
            </View>
          </BlurView>
        </View>
      </Modal>
    </View>
  );
};


const OnboardingFlow = ({ onRegister, pendingInvite }) => {
  const [step, setStep] = useState(0);
  const [name, setName] = useState(''); 
  const [email, setEmail] = useState(''); 
  const [phone, setPhone] = useState('');
  const [password, setPassword] = useState(''); 
  const [isRegistering, setIsRegistering] = useState(false);
  
  const fadeAnim = useRef(new Animated.Value(1)).current;

  // AUTO-NAVIGATE IF INVITE EXISTS
  useEffect(() => {
    if (pendingInvite && step === 0) {
        setStep(2); // Jump straight to registration form
    }
  }, [pendingInvite]);

  const goToStep = (nextStep) => {
    Animated.timing(fadeAnim, {
      toValue: 0,
      duration: 200,
      useNativeDriver: true,
    }).start(() => {
      setStep(nextStep);
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 300,
        useNativeDriver: true,
      }).start();
    });
  };

  const renderContent = () => {
    // Step 0: Intro
    if (step === 0) {
      return (
        <SafeAreaView style={styles.onboardingContent}>
          <TouchableOpacity style={styles.skipBtn} onPress={() => goToStep(2)}>
            <Text style={styles.skipText}>Skip</Text>
          </TouchableOpacity>
          <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
            <Text style={{fontSize: 80}}>üèÉ‚Äç‚ôÇÔ∏è</Text>
            <Text style={styles.onboardingTitle}>Run Smarter.</Text>
          </View>
          <TouchableOpacity style={styles.onboardingBtn} onPress={() => goToStep(1)}>
            <Text style={styles.buttonText}>Next</Text>
          </TouchableOpacity>
        </SafeAreaView>
      );
    }

    // Step 1: Insights
    if (step === 1) {
      return (
        <SafeAreaView style={styles.onboardingContent}>
          <TouchableOpacity style={styles.skipBtn} onPress={() => goToStep(2)}>
            <Text style={styles.skipText}>Skip</Text>
          </TouchableOpacity>
          <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
            <Text style={{fontSize: 80}}>üìà</Text>
            <Text style={styles.onboardingTitle}>Track Performance.</Text>
            <Text style={[styles.subGreeting, {textAlign: 'center', paddingHorizontal: 20}]}>
              Analyze your stride and crush your personal records with real-time data.
            </Text>
          </View>
          <TouchableOpacity style={styles.onboardingBtn} onPress={() => goToStep(2)}>
            <Text style={styles.buttonText}>Next</Text>
          </TouchableOpacity>
        </SafeAreaView>
      );
    }

  // Step 2: Registration
    return (
      <KeyboardAvoidingView 
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'} 
        style={{ flex: 1 }}
      >
        <ScrollView 
          contentContainerStyle={{ flexGrow: 1 }} 
          keyboardShouldPersistTaps="handled"
        >
          <SafeAreaView style={styles.onboardingContent}>
            <View style={{ marginTop: 20 }}>
              {/* DYNAMIC TITLE BASED ON INVITE */}
              <Text style={styles.greeting}>
                {pendingInvite ? `Join ${pendingInvite.clubName}` : "Create Profile"}
              </Text>
              {pendingInvite && (
                 <Text style={{color:'#3b82f6', marginBottom:10}}>You've been invited by {pendingInvite.inviterName}</Text>
              )}
              
              <GlassCard style={{ marginTop: 20 }}>
                <Text style={styles.label}>NAME</Text>
                <TextInput style={styles.input} value={name} onChangeText={setName} placeholder="Your Name" placeholderTextColor="#555" />
                
                <Text style={styles.label}>EMAIL</Text>
                <TextInput style={styles.input} value={email} onChangeText={setEmail} keyboardType="email-address" autoCapitalize="none" placeholder="runner@email.com" placeholderTextColor="#555" />
                
                <Text style={styles.label}>PHONE</Text>
                <TextInput style={styles.input} value={phone} onChangeText={setPhone} keyboardType="phone-pad" placeholder="Phone Number" placeholderTextColor="#555" />

                <Text style={styles.label}>PASSWORD</Text>
                <TextInput 
                    style={styles.input} 
                    value={password} 
                    onChangeText={setPassword} 
                    secureTextEntry 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                    placeholderTextColor="#555" 
                />

  <TouchableOpacity 
  style={[
    styles.onboardingBtn, 
    { width: '100%', marginTop: 30, alignItems: 'center', opacity: isRegistering ? 0.7 : 1 }
  ]} 
  onPress={async () => {
    if (!password || password.length < 6) {
        Alert.alert("Weak Password", "Password must be at least 6 characters.");
        return;
    }
    setIsRegistering(true); 
    try {
      await onRegister(email, password, name, phone);
    } catch (e) {
      setIsRegistering(false); 
      Alert.alert("Error", e.message);
    }
  }}
  disabled={isRegistering} 
>
  {isRegistering ? (
    <ActivityIndicator color="white" />
  ) : (
    <Text style={styles.buttonText}>Enter Dashboard</Text>
  )}
</TouchableOpacity>
              </GlassCard>
            </View>
          </SafeAreaView>
        </ScrollView>
      </KeyboardAvoidingView>
    );
  };

  return (
    <View style={styles.onboardingContainer}>
      <LinearGradient 
        colors={step === 0 ? ['#991b1b', '#000000'] : ['#000000', '#1e3a8a']} 
        style={styles.background} 
      />
      <Animated.View style={{ flex: 1, opacity: fadeAnim }}>
        {renderContent()}
      </Animated.View>
    </View>
  );
};
// --- CLUBS SCREEN (Redesigned Premium Card) ---
const ClubsScreen = ({ setCurrentScreen, clubs, onSelectClub, userProfile, onUnlockFounder }) => {
  
  // Helper component for the feature rows (The "Pills")
  const FeatureItem = ({ icon, label }) => (
    <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: 'rgba(255,255,255,0.08)', padding: 16, borderRadius: 16, marginBottom: 10 }}>
       <Text style={{ fontSize: 20, marginRight: 15 }}>{icon}</Text>
       <Text style={{ color: 'white', fontWeight: 'bold', fontSize: 14 }}>{label}</Text>
    </View>
  );

  // Filter clubs: Show clubs where the user is a member OR the admin
  const myClubs = clubs.filter(c => 
      c.adminId === userProfile.uid || 
      (c.members && c.members.some(m => m.email === userProfile.email))
  );

  return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
      <TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}>
        <Text style={styles.backBtnText}>‚Üê Back</Text>
      </TouchableOpacity>
      
      <View style={styles.row}>
        <Text style={styles.greeting}>Clubs</Text>
        {userProfile?.isFounder && (
          <TouchableOpacity onPress={() => setCurrentScreen('CreateClub')}>
            <Text style={{color:'#ef4444', fontSize:30}}>+</Text>
          </TouchableOpacity>
        )}
      </View>
  
      {/* --- PREMIUM UPGRADE CARD --- */}
      {/* Logic: If NOT a founder, show the Promo Card. */}
      {!userProfile?.isFounder && (
        <GlassCard style={{ marginTop: 10, borderColor: '#3b82f6', paddingVertical: 30, alignItems: 'center' }}>
          
          {/* Header Icon */}
          <View style={{ width: 70, height: 70, borderRadius: 35, backgroundColor: 'rgba(59, 130, 246, 0.15)', justifyContent: 'center', alignItems: 'center', marginBottom: 20 }}>
             <Text style={{ fontSize: 32 }}>üîì</Text>
          </View>
  
          {/* Titles */}
          <Text style={{ color: 'white', fontSize: 24, fontWeight: '900', textAlign: 'center', marginBottom: 5 }}>Founder Access</Text>
          <Text style={{ color: 'rgba(255,255,255,0.5)', fontSize: 14, textAlign: 'center', marginBottom: 30 }}>
            Unlock your full community potential
          </Text>
  
          {/* Feature List (Inspired by your image) */}
          <View style={{ width: '100%', marginBottom: 15 }}>
             <FeatureItem icon="üëë" label="Create & Own Running Clubs" />
             <FeatureItem icon="üìä" label="Advanced Leaderboards" />
             <FeatureItem icon="üì¢" label="Post Group Announcements" />
             <FeatureItem icon="üí¨" label="Unlimited Club Chat" />
          </View>
  
          {/* Price Button */}
          <TouchableOpacity 
            style={[styles.mainActionButton, { marginTop: 10, backgroundColor: '#3b82f6', width: '100%' }]} 
            onPress={onUnlockFounder}
          >
            <Text style={styles.buttonText}>Get Founder Access - $9.99/mo</Text>
          </TouchableOpacity>
        </GlassCard>
      )}
  
      {/* --- LIST OF MY CLUBS --- */}
      {/* Logic: ALWAYS show clubs the user belongs to, even if they aren't a founder */}
      <Text style={[styles.cardTitle, {marginTop: 20, marginBottom: 10}]}>My Clubs</Text>
      {myClubs.length > 0 ? (
          myClubs.map(c => (
            <TouchableOpacity key={c.id} onPress={() => onSelectClub(c)}>
              <GlassCard style={{marginTop: 10}}>
                <Text style={styles.valueTitle}>{c.name}</Text>
                <Text style={styles.valueDesc}>{(c.members || []).length} members</Text>
              </GlassCard>
            </TouchableOpacity>
          ))
      ) : (
          <Text style={{color: 'gray', textAlign: 'center', marginTop: 20}}>You haven't joined any clubs yet.</Text>
      )}
    </ScrollView>
  );
};

const CreateClubScreen = ({ setCurrentScreen, onLaunch }) => { const [name, setName] = useState(''); return <ScrollView contentContainerStyle={styles.scrollContent}><TouchableOpacity onPress={() => setCurrentScreen('Clubs')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity><GlassCard><TextInput style={styles.input} placeholder="Club Name" value={name} onChangeText={setName}/><TouchableOpacity style={[styles.mainActionButton, {marginTop:20}]} onPress={() => onLaunch(name)}><Text style={styles.buttonText}>Launch</Text></TouchableOpacity></GlassCard></ScrollView>; };
const JoinClubScreen = ({ setCurrentScreen, onJoin }) => { const [code, setCode] = useState(''); return <ScrollView contentContainerStyle={styles.scrollContent}><TouchableOpacity onPress={() => setCurrentScreen('Home')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity><GlassCard style={{marginTop:60}}><TextInput style={styles.input} placeholder="Enter Club ID" value={code} onChangeText={setCode}/><TouchableOpacity style={[styles.mainActionButton, {marginTop:20}]} onPress={() => onJoin(code)}><Text style={styles.buttonText}>Join</Text></TouchableOpacity></GlassCard></ScrollView>; };
const ClubDetailScreen = ({ setCurrentScreen, club, isAdmin, onDeleteClub, onUpdateAnnouncement, onRemoveMember, onLeaveClub, onInviteMember, userProfile, onToggleMute }) => {
  const [activeTab, setActiveTab] = useState('Leaderboard'); 
  const [filter, setFilter] = useState('Current Month'); 
  const [annTitle, setAnnTitle] = useState(''); 
  const [annBody, setAnnBody] = useState(''); 
  const [showAnnModal, setShowAnnModal] = useState(false); 
  const [targetAnn, setTargetAnn] = useState(null);
  const [showInviteModal, setShowInviteModal] = useState(false);
  const [inviteEmail, setInviteEmail] = useState('');
  const [isInviting, setIsInviting] = useState(false); // NEW LOADING STATE
  
  if (!club) return null;
  const currentMonthKey = new Date().toLocaleString('default', { month: 'short', year: '2-digit' });
  const ranked = [...club.members].sort((a,b) => filter === 'All Time' ? (b.miles||0)-(a.miles||0) : ((b.history&&b.history[currentMonthKey])||0)-((a.history&&a.history[currentMonthKey])||0));
  
  const currentUserMember = club.members.find(m => m.email === userProfile?.email);
  const isMuted = currentUserMember?.muted || false;

  const confirmRemove = (member) => {
      Alert.alert("Remove Member?", `Are you sure you want to remove ${member.name} from the club?`, [
          { text: "Cancel", style: "cancel" },
          { text: "Remove", style: "destructive", onPress: () => onRemoveMember(club.id, member.email) }
      ]);
  };

  const confirmLeave = () => {
      Alert.alert("Leave Club?", `Are you sure you want to leave ${club.name}?`, [
          { text: "Cancel", style: "cancel" },
          { text: "Leave", style: "destructive", onPress: () => onLeaveClub(club.id) }
      ]);
  };
  
  const handleInvite = () => {
    setShowInviteModal(true);
  };

  return (
    <ScrollView contentContainerStyle={styles.scrollContent}>
      <TouchableOpacity onPress={() => setCurrentScreen('Clubs')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity>
      
      {/* Header with Mute Toggle */}
      <View style={{flexDirection: 'row', justifyContent:'space-between', alignItems:'center'}}>
          <Text style={[styles.greeting, {flex: 1}]}>{club.name}</Text>
          <TouchableOpacity onPress={() => onToggleMute(club.id, !isMuted)} style={{padding: 10, backgroundColor: isMuted ? '#ef4444' : 'rgba(255,255,255,0.1)', borderRadius: 20}}>
              <Text style={{fontSize: 20}}>{isMuted ? "üîï" : "üîî"}</Text>
          </TouchableOpacity>
      </View>
      
      {/* INVITE MEMBER BUTTON (Strictly Admin Only) */}
      {isAdmin && (
         <TouchableOpacity style={[styles.secondaryActionButton, {marginBottom: 10, borderColor:'#22c55e', backgroundColor: 'rgba(34, 197, 94, 0.1)'}]} onPress={handleInvite}>
            <Text style={{color:'#22c55e', fontWeight:'bold', fontSize:16}}>‚úâÔ∏è Invite New Members</Text>
         </TouchableOpacity>
      )}

      <TouchableOpacity style={[styles.secondaryActionButton, {marginBottom: 10, borderColor:'#3b82f6'}]} onPress={() => setCurrentScreen('ClubChat')}>
          <Text style={{color:'#3b82f6', fontWeight:'bold', fontSize:16}}>üí¨ Message Board</Text>
      </TouchableOpacity>

      <View style={styles.tabContainer}>{['Leaderboard', 'Feed', 'Roster'].map(t=><TouchableOpacity key={t} style={[styles.tabBtn, activeTab===t&&styles.tabBtnActive]} onPress={()=>setActiveTab(t)}><Text style={styles.tabText}>{t}</Text></TouchableOpacity>)}</View>
      
      {activeTab === 'Leaderboard' && <View><View style={styles.filterRow}><TouchableOpacity onPress={()=>setFilter('Current Month')} style={[styles.filterBtn, filter==='Current Month'&&styles.filterBtnActive]}><Text style={styles.buttonText}>{currentMonthKey}</Text></TouchableOpacity><TouchableOpacity onPress={()=>setFilter('All Time')} style={[styles.filterBtn, filter==='All Time'&&styles.filterBtnActive]}><Text style={styles.buttonText}>All Time</Text></TouchableOpacity></View><GlassCard>{ranked.map((m,i)=><View key={i} style={styles.leaderboardItem}>
        <Text style={styles.rankText}>
          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}.`}
        </Text>
      <Text style={styles.shoeName}>{m.name}</Text><Text style={styles.historyMiles}>{(filter==='All Time'?m.miles:m.history?.[currentMonthKey]||0).toFixed(1)} mi</Text></View>)}</GlassCard></View>}
      
      {activeTab === 'Feed' && <View>{isAdmin && <TouchableOpacity style={[styles.secondaryActionButton, {marginBottom:20}]} onPress={()=>setCurrentScreen('AnnouncementComposer')}><Text style={styles.buttonText}>+ Post Announcement</Text></TouchableOpacity>}{club.announcements.map((a, i)=><GlassCard key={a.id || i} style={{marginBottom:10}}><View style={styles.row}><Text style={styles.valueTitle}>{a.title}</Text>{isAdmin&&<TouchableOpacity onPress={()=>{setTargetAnn(a);setAnnTitle(a.title);setAnnBody(a.body);setShowAnnModal(true);}}><Text style={{color:'#3b82f6'}}>Edit</Text></TouchableOpacity>}</View><Text style={styles.valueDesc}>{a.body}</Text><TouchableOpacity style={styles.kudosBtn} onPress={()=>Alert.alert("Kudos!","üî•")}><Text style={{color:'white'}}>üî• Kudos</Text></TouchableOpacity></GlassCard>)}</View>}
      
      {activeTab === 'Roster' && (
          <GlassCard>
            {club.members.map((m,i) => (
                <View key={i} style={styles.memberDirectoryItem}>
                    <View style={{ flex: 1 }}>
                        <Text style={styles.valueTitle}>{m.name}</Text>
                        <Text style={styles.valueDesc}>{m.email}</Text>
                    </View>
                    
                    {/* ADMIN: REMOVE MEMBER (Not self) */}
                    {isAdmin && m.email !== userProfile?.email && (
                        <TouchableOpacity onPress={() => confirmRemove(m)} style={{ backgroundColor: 'rgba(239,68,68,0.2)', paddingHorizontal: 10, paddingVertical: 6, borderRadius: 8 }}>
                            <Text style={{color: '#ef4444', fontSize: 12, fontWeight: 'bold'}}>Remove</Text>
                        </TouchableOpacity>
                    )}

                    {/* MEMBER: LEAVE CLUB (Self Only, Non-Admin) */}
                    {!isAdmin && m.email === userProfile?.email && (
                        <TouchableOpacity onPress={confirmLeave} style={{ backgroundColor: 'rgba(239,68,68,0.2)', paddingHorizontal: 10, paddingVertical: 6, borderRadius: 8 }}>
                            <Text style={{color: '#ef4444', fontSize: 12, fontWeight: 'bold'}}>Leave</Text>
                        </TouchableOpacity>
                    )}
                </View>
            ))}
            {isAdmin && <TouchableOpacity onPress={()=>onDeleteClub(club.id)} style={{marginTop:20, alignSelf:'center'}}><Text style={{color:'#ef4444', fontWeight:'bold'}}>Delete Entire Club</Text></TouchableOpacity>}
          </GlassCard>
      )}

      {/* ANNOUNCEMENT MODAL */}
      <Modal transparent visible={showAnnModal} animationType="fade"><View style={styles.modalOverlay}><BlurView intensity={100} tint="dark" style={styles.confirmModal}><TextInput style={styles.input} value={annTitle} onChangeText={setAnnTitle}/><TextInput style={[styles.input,{height:100}]} multiline value={annBody} onChangeText={setAnnBody}/><TouchableOpacity style={styles.mainActionButton} onPress={()=>{if(targetAnn)onUpdateAnnouncement(club.id,targetAnn.id,annTitle,annBody);setShowAnnModal(false);}}><Text style={styles.buttonText}>Save</Text></TouchableOpacity></BlurView></View></Modal>

      {/* INVITE MODAL (FIXED) */}
      <Modal transparent visible={showInviteModal} animationType="slide"><View style={styles.modalOverlay}><BlurView intensity={100} tint="dark" style={styles.confirmModal}>
          <Text style={styles.modalTitle}>Invite Member</Text>
          <Text style={{color:'gray', textAlign:'center', marginBottom:20}}>Generate a unique link to invite a new runner.</Text>
          <TouchableOpacity 
            style={[styles.mainActionButton, {backgroundColor:'#22c55e', width: '100%', flex: 0, height: 55, justifyContent: 'center', alignItems: 'center'}]} 
            onPress={async ()=>{
              setIsInviting(true);
              // Wait for share sheet to prepare
              await new Promise(resolve => setTimeout(resolve, 500)); 
              try {
                  await onInviteMember(club.id, club.name); 
                  setShowInviteModal(false);
              } catch(e) {}
              setIsInviting(false);
          }} disabled={isInviting}>
              {isInviting ? <ActivityIndicator color="white" /> : <Text style={styles.buttonText}>Send Invite</Text>}
          </TouchableOpacity>
          <TouchableOpacity style={[styles.cancelButton, {marginTop:15}]} onPress={()=>setShowInviteModal(false)}><Text style={styles.buttonText}>Cancel</Text></TouchableOpacity>
      </BlurView></View></Modal>
    </ScrollView>
  );
};
const AnnouncementComposer = ({ setCurrentScreen, club, onPost }) => { const [t, setT] = useState(''); const [b, setB] = useState(''); return <ScrollView contentContainerStyle={styles.scrollContent}><TouchableOpacity onPress={() => setCurrentScreen('ClubDetail')} style={styles.backBtn}><Text style={styles.backBtnText}>‚Üê Back</Text></TouchableOpacity><GlassCard><TextInput style={styles.input} placeholder="Title" value={t} onChangeText={setT}/><TextInput style={[styles.input,{height:100}]} multiline placeholder="Body" value={b} onChangeText={setB}/><TouchableOpacity style={[styles.mainActionButton, {marginTop:20}]} onPress={()=>onPost(club.id,t,b)}><Text style={styles.buttonText}>Post Announcement</Text></TouchableOpacity></GlassCard></ScrollView>; };

const HomeScreen = ({ setCurrentScreen, shoes, userProfile, monthlyMiles, onLogout }) => (
    <ScrollView contentContainerStyle={styles.scrollContent}>
        <View style={[styles.row, {marginVertical:10}]}><Text style={{color:'white', fontWeight:'900', fontSize:16}}>STRIDE 4 STRIDE</Text><TouchableOpacity onPress={() => setCurrentScreen('Profile')} style={styles.profileIconBtn}><Text style={{fontSize:20}}>üë§</Text></TouchableOpacity></View>
        <View style={styles.row}><View>
            <Text style={styles.greeting}>Hello, {userProfile?.fullName?.split(' ')[0]}</Text>
            {/* PUSH STATUS INDICATOR */}
            <Text style={{color: userProfile?.pushToken ? '#4ade80' : '#ef4444', fontSize: 12, fontWeight: 'bold'}}>
                {userProfile?.pushToken ? "üîî Notifications Active" : "üîï No Token (Re-login)"}
            </Text>
            <Text style={styles.subGreeting}>Let's run.</Text>
        </View></View>
        <View style={styles.buttonContainer}><TouchableOpacity style={[styles.mainActionButton, {backgroundColor: '#22c55e'}]} onPress={() => setCurrentScreen('RunTracker')}><Text style={styles.buttonText}>‚ö° Go Run</Text></TouchableOpacity><TouchableOpacity style={styles.secondaryActionButton} onPress={() => setCurrentScreen('Log')}><Text style={styles.buttonText}>Log Manual</Text></TouchableOpacity></View>
        <TouchableOpacity style={[styles.secondaryActionButton, {marginTop: 15}]} onPress={() => setCurrentScreen('Clubs')}><Text style={styles.buttonText}>Clubs Hub</Text></TouchableOpacity>
        <GlassCard style={{ marginTop: 25 }}><View style={styles.row}><Text style={styles.cardTitle}>This Month</Text><TouchableOpacity onPress={() => setCurrentScreen('History')}><Text style={styles.manageLink}>History</Text></TouchableOpacity></View><Text style={styles.milesTotal}>{monthlyMiles} <Text style={{fontSize: 20, fontWeight: '400'}}>mi</Text></Text></GlassCard>
        <GlassCard><View style={styles.row}><Text style={styles.cardTitle}>Shoe Mileage</Text><TouchableOpacity onPress={() => setCurrentScreen('ManageShoes')}><Text style={styles.manageLink}>Manage</Text></TouchableOpacity></View>{shoes.filter(s => !s.retired).slice(0, 3).map(shoe => (<View key={shoe.id} style={styles.shoeItem}><Text style={styles.shoeName}>{shoe.name}</Text><View style={styles.progressBarBase}><View style={[styles.progressBarFill, { width: `${Math.min(((shoe.miles || 0)/shoe.limit)*100, 100)}%`, backgroundColor: '#3b82f6' }]} /></View><Text style={styles.shoeMiles}>{(shoe.miles || 0).toFixed(1)} / {shoe.limit} miles</Text></View>))}</GlassCard>
        <TouchableOpacity style={styles.joinCodeBtn} onPress={() => setCurrentScreen('JoinClub')}>
            <Text style={styles.joinCodeText}>Join a Club with Code</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.logoutBtn} onPress={onLogout}><Text style={styles.logoutText}>Log Out</Text></TouchableOpacity>
    </ScrollView>
);

const ClubChatScreen = ({ setCurrentScreen, club, user, userProfile }) => { 
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  
  useEffect(() => {
    if (!club) return;
    const q = query(collection(db, "clubs", club.id, "messages"), orderBy("createdAt", "asc"));
    const unsub = onSnapshot(q, (snapshot) => {
      setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsub();
  }, [club]);

  // --- ROBUST NOTIFICATION HELPER ---
  const sendClubNotification = async (targetClub, title, body, data, excludeEmail) => {
    // 1. Get List of Emails to Notify
    const recipientEmails = targetClub.members
        .filter(m => m.email.toLowerCase() !== excludeEmail.toLowerCase() && !m.muted) // Case-insensitive
        .map(m => m.email.toLowerCase());

    if (recipientEmails.length === 0) return;

    // 2. Fetch Tokens in Parallel
    const tokenPromises = recipientEmails.map(async (email) => {
        // Query users by email (Note: Firestore is case-sensitive, so this relies on saved email casing)
        // Best practice: save emails as lowercase during signup.
        const q = query(collection(db, "users"), where("email", "==", email));
        const snap = await getDocs(q);
        if (!snap.empty && snap.docs[0].data().pushToken) {
            return snap.docs[0].data().pushToken;
        }
        return null;
    });

    const results = await Promise.all(tokenPromises);
    const validTokens = results.filter(t => t);

    // 3. Send if tokens exist
    if (validTokens.length > 0) {
        await sendPushNotification(validTokens, title, body, data);
    } else {
        // Alert for debugging/feedback
        Alert.alert("Notification Info", `Found ${recipientEmails.length} members, but 0 have push tokens. Have they logged in recently?`);
    }
  };

  const handleSend = async () => {
    if (inputText.trim() === '') return;
    const text = inputText;
    setInputText('');
    
    let displayName = user.email.split('@')[0]; 
    if (userProfile?.fullName) {
        const parts = userProfile.fullName.trim().split(/\s+/);
        displayName = parts.length > 1 ? `${parts[0]} ${parts[1].charAt(0).toUpperCase()}.` : parts[0];
    }

    try {
      await addDoc(collection(db, "clubs", club.id, "messages"), {
        text,
        senderId: user.uid,
        senderName: displayName, 
        createdAt: new Date(),
      });
      
      // SEND ROBUST NOTIFICATION
      await sendClubNotification(
          club, 
          `üí¨ ${club.name}`, 
          `${displayName}: ${text}`, 
          { screen: 'ClubChat', clubId: club.id }, 
          user.email
      );

    } catch (e) { Alert.alert("Error", e.message); }
  };
  
  return (
    <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : 'height'} style={{flex: 1}}>
        <SafeAreaView style={{flex: 1, backgroundColor: 'black'}}>
            <View style={{flexDirection: 'row', alignItems: 'center', padding: 15, borderBottomWidth: 1, borderBottomColor: 'rgba(255,255,255,0.1)'}}>
                <TouchableOpacity onPress={() => setCurrentScreen('ClubDetail')}><Text style={{color: '#ef4444', fontSize: 16, fontWeight: 'bold'}}>‚Üê Back</Text></TouchableOpacity>
                <Text style={{color: 'white', fontSize: 18, fontWeight: 'bold', marginLeft: 15}}>{club.name}</Text>
            </View>
            <FlatList 
                data={messages}
                keyExtractor={item => item.id}
                renderItem={({item}) => (
                    <View style={{marginBottom: 10, alignSelf: item.senderId === user.uid ? 'flex-end' : 'flex-start', maxWidth: '80%'}}>
                        <Text style={{color: 'gray', fontSize: 10, marginBottom: 2, alignSelf: item.senderId === user.uid ? 'flex-end' : 'flex-start'}}>
                            {item.senderName}
                        </Text>
                        <View style={{backgroundColor: item.senderId === user.uid ? '#3b82f6' : 'rgba(255,255,255,0.1)', padding: 12, borderRadius: 16}}>
                            <Text style={{color: 'white'}}>{item.text}</Text>
                        </View>
                    </View>
                )}
                contentContainerStyle={{padding: 15}}
            />
            <View style={{flexDirection: 'row', padding: 10, borderTopWidth: 1, borderTopColor: 'rgba(255,255,255,0.1)', alignItems:'center'}}>
                <TextInput 
                    style={[styles.input, {flex: 1, marginBottom: 0, marginRight: 10}]} 
                    value={inputText} 
                    onChangeText={setInputText} 
                    placeholder="Type a message..." 
                    placeholderTextColor="gray" 
                />
                <TouchableOpacity style={[styles.mainActionButton, {paddingVertical: 12, paddingHorizontal: 20}]} onPress={handleSend}>
                    <Text style={styles.buttonText}>Send</Text>
                </TouchableOpacity>
            </View>
        </SafeAreaView>
    </KeyboardAvoidingView>
  );
};

export default function App() {
  const [hasSeenOnboarding, setHasSeenOnboarding] = useState(null); const [user, setUser] = useState(null); const [userProfile, setUserProfile] = useState({}); const [currentScreen, setCurrentScreen] = useState('Home'); const [showToast, setShowToast] = useState(false); const [toastMessage, setToastMessage] = useState(''); const [runs, setRuns] = useState([]); const [expoPushToken, setExpoPushToken] = useState(''); const [clubs, setClubs] = useState([]); const [shoeInventory, setShoeInventory] = useState([]); const [selectedClub, setSelectedClub] = useState(null);
  const [pendingInvite, setPendingInvite] = useState(null);

  useEffect(() => { registerForPushNotificationsAsync().then(token => { if (token) setExpoPushToken(token); }); }, []);
  useEffect(() => { const check = async () => setHasSeenOnboarding((await AsyncStorage.getItem('hasSeenOnboarding')) === 'true'); check(); const unsub = onAuthStateChanged(auth, (usr) => { setUser(usr); if(usr) setHasSeenOnboarding(true); }); return () => unsub(); }, []);
  useEffect(() => { 
      if (!user) return; 
      const pU = onSnapshot(doc(db, "users", user.uid), (d) => { if(d.exists()) setUserProfile(d.data()); }); 
      const rU = onSnapshot(query(collection(db, "runs"), where("userId", "==", user.uid), orderBy("createdAt", "desc")), (s) => setRuns(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
      const cU = onSnapshot(collection(db, "clubs"), (s) => setClubs(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
      const sU = onSnapshot(query(collection(db, "shoes"), where("userId", "==", user.uid)), (s) => setShoeInventory(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
      
      // --- FORCE TOKEN SYNC ON LOGIN ---
      if (expoPushToken) {
          updateDoc(doc(db, "users", user.uid), { pushToken: expoPushToken });
      }

      return () => { pU(); rU(); cU(); sU(); }; 
  }, [user, expoPushToken]);
  
  // --- ROBUST NOTIFICATION LISTENER ---
  useEffect(() => {
      const responseListener = Notifications.addNotificationResponseReceivedListener(response => {
          const data = response.notification.request.content.data;
          
          if (data && data.clubId) {
              const targetClub = clubs.find(c => c.id === data.clubId);
              
              const navigate = (clubData) => {
                  setSelectedClub(clubData);
                  // Intelligent routing based on payload
                  if (data.screen === 'ClubChat') setCurrentScreen('ClubChat');
                  else if (data.screen === 'ClubDetail') setCurrentScreen('ClubDetail');
              };

              if (targetClub) {
                  navigate(targetClub);
              } else {
                  // Fallback: Fetch fresh club data
                  getDoc(doc(db, 'clubs', data.clubId)).then(snap => {
                      if (snap.exists()) {
                          navigate({id: snap.id, ...snap.data()});
                      }
                  });
              }
          }
      });
      return () => responseListener.remove();
  }, [clubs]);

  useEffect(() => { if (selectedClub) { const live = clubs.find(c => c.id === selectedClub.id); if (live) setSelectedClub(live); } }, [clubs]);
  
  // --- DEEP LINK LISTENER ---
  useEffect(() => {
    const handleDeepLink = async (event) => {
        let url = event.url;
        if (!url) return;
        let { queryParams } = Linking.parse(url);
        if (queryParams && queryParams.inviteId) {
            try {
                const invRef = doc(db, "invites", queryParams.inviteId);
                const invSnap = await getDoc(invRef);
                if (invSnap.exists()) {
                    const data = invSnap.data();
                    const now = Date.now();
                    const created = data.createdAt.toMillis ? data.createdAt.toMillis() : data.createdAt;
                    if (now - created > 86400000) {
                        Alert.alert("Expired", "This invite link has expired.");
                    } else {
                        setPendingInvite({ id: queryParams.inviteId, ...data });
                        if (!user) { setHasSeenOnboarding(false); } else {
                            Alert.alert("Club Invite", `Join ${data.clubName}?`, [{ text: "No" }, { text: "Join", onPress: () => processJoin(data.clubId, user) }]);
                        }
                    }
                }
            } catch (e) { console.log("Invite Error:", e); }
        }
    };
    Linking.getInitialURL().then(url => handleDeepLink({ url }));
    const sub = Linking.addEventListener('url', handleDeepLink);
    return () => sub.remove();
  }, [user]);

  const processJoin = async (clubId, usr) => {
      try {
          const uSnap = await getDoc(doc(db, "users", usr.uid));
          const uData = uSnap.data();
          await updateDoc(doc(db, "clubs", clubId), {
              members: arrayUnion({
                  name: uData.fullName,
                  email: uData.email,
                  phone: uData.phone,
                  miles: 0,
                  shareConsent: true,
                  muted: false
              })
          });
          Alert.alert("Joined!", "You have been added to the club.");
          setPendingInvite(null);
          setCurrentScreen('Clubs');
      } catch (e) { Alert.alert("Join Error", e.message); }
  };

  const handleLeaveClub = async (clubId) => {
      try {
          const clubRef = doc(db, "clubs", clubId);
          const clubSnap = await getDoc(clubRef);
          if (clubSnap.exists()) {
              const currentMembers = clubSnap.data().members || [];
              const updated = currentMembers.filter(m => m.email !== userProfile.email);
              await updateDoc(clubRef, { members: updated });
              Alert.alert("Left Club", "You have successfully left the club.");
              setCurrentScreen('Clubs'); 
          }
      } catch (e) { Alert.alert("Error", e.message); }
  };
  
  const handleRemoveMember = async (clubId, memberEmail) => {
      try {
          const clubRef = doc(db, "clubs", clubId);
          const clubSnap = await getDoc(clubRef);
          if (clubSnap.exists()) {
              const currentMembers = clubSnap.data().members || [];
              const updated = currentMembers.filter(m => m.email !== memberEmail);
              await updateDoc(clubRef, { members: updated });
              Alert.alert("Success", "Member removed from club.");
          }
      } catch (e) { Alert.alert("Error", e.message); }
  };

  const handleInviteMember = async (clubId, clubName) => {
      try {
          const invRef = await addDoc(collection(db, "invites"), {
              clubId, clubName, inviterId: user.uid,
              inviterName: userProfile.fullName || "A Founder", createdAt: Date.now(), status: 'pending'
          });
          const link = Linking.createURL('/', { queryParams: { inviteId: invRef.id } });
          await Share.share({ message: `Join me in ${clubName} on Stride 4 Stride! Click here: ${link}` });
      } catch (e) { Alert.alert("Error", e.message); }
  };

  const handleToggleMute = async (clubId, isMuted) => {
      try {
          const clubRef = doc(db, "clubs", clubId);
          const clubSnap = await getDoc(clubRef);
          if (clubSnap.exists()) {
              const currentMembers = clubSnap.data().members || [];
              const updated = currentMembers.map(m => {
                  if (m.email === user.email) return { ...m, muted: isMuted };
                  return m;
              });
              await updateDoc(clubRef, { members: updated });
              Alert.alert("Success", isMuted ? "Notifications Muted" : "Notifications On");
          }
      } catch (e) { Alert.alert("Error", e.message); }
  };

  const handleSaveRun = async (newRun) => { if (!user) return; try { await addDoc(collection(db, "runs"), { ...newRun, userId: user.uid, createdAt: new Date() }); if (newRun.club && newRun.club !== 'None') { const q = query(collection(db, "clubs"), where("name", "==", newRun.club)); const snap = await getDocs(q); if (!snap.empty) { const cDoc = snap.docs[0]; const cData = cDoc.data(); const k = new Date().toLocaleString('default', { month: 'short', year: '2-digit' }); const updated = cData.members.map(m => m.email === user.email ? { ...m, miles: (m.miles || 0) + newRun.distance, history: { ...m.history, [k]: ((m.history && m.history[k]) || 0) + newRun.distance } } : m); await updateDoc(doc(db, "clubs", cDoc.id), { members: updated }); } } setToastMessage("Run Saved!"); setShowToast(true); setCurrentScreen('History'); } catch (e) { Alert.alert("Error", e.message); } };
  
  // --- ROBUST ANNOUNCEMENT POSTING ---
  const handlePostAnnouncement = async (cId, t, b) => { 
      try { 
          await updateDoc(doc(db, "clubs", cId), { announcements: arrayUnion({ id: Date.now(), title: t, body: b }) }); 
          setCurrentScreen('ClubDetail'); 
          
          const targetClub = clubs.find(cl => cl.id === cId);
          if (targetClub) {
              // Re-use robust notification logic inline
              const recipientEmails = targetClub.members
                  .filter(m => m.email.toLowerCase() !== user.email.toLowerCase() && !m.muted) // Case-insensitive
                  .map(m => m.email.toLowerCase());

              if (recipientEmails.length > 0) {
                   const tokenPromises = recipientEmails.map(async (email) => {
                      const q = query(collection(db, "users"), where("email", "==", email)); // Match exactly how stored
                      const snap = await getDocs(q);
                      if (!snap.empty) return snap.docs[0].data().pushToken;
                      return null;
                  });
                  const results = await Promise.all(tokenPromises);
                  const validTokens = results.filter(tk => tk);
                  
                  if (validTokens.length > 0) {
                      await sendPushNotification(validTokens, `üì¢ ${targetClub.name}`, `${t}: ${b}`, { screen: 'ClubDetail', clubId: cId });
                      Alert.alert("Success", "Announcement posted & Notifications sent!");
                  } else {
                      Alert.alert("Posted", `Announcement posted, but 0 active devices found for ${recipientEmails.length} members.`);
                  }
              } else {
                  Alert.alert("Posted", "Announcement posted (No unmuted members to notify).");
              }
          }
      } catch (e) { Alert.alert("Error", e.message); } 
  };
  
  const monthlyMiles = runs.reduce((acc, curr) => acc + (curr.distance || 0), 0).toFixed(1);
  const shoesWithMiles = shoeInventory.map(shoe => ({ ...shoe, miles: (shoe.initialMiles || 0) + runs.filter(r => r.shoeId === shoe.id).reduce((acc, curr) => acc + (curr.distance || 0), 0) }));

  if (hasSeenOnboarding === null) return <View style={{flex:1, backgroundColor: '#000'}}><ActivityIndicator size="large" color="#fff" /></View>;
  
  if (!user) return hasSeenOnboarding ? (
    <LoginScreen 
      onLogin={signInWithEmailAndPassword.bind(null, auth)} 
      onGoToSignUp={() => setHasSeenOnboarding(false)} 
    />
  ) : (
    <OnboardingFlow 
      pendingInvite={pendingInvite} 
      onRegister={async (email, password, name, phone) => {
        // Enforce lowercase email for consistency
        const cleanEmail = email.toLowerCase();
        const cred = await createUserWithEmailAndPassword(auth, cleanEmail, password);
        await setDoc(doc(db, "users", cred.user.uid), {
          fullName: name,
          email: cleanEmail,
          phone: phone,
          shareConsent: true,
          createdAt: new Date(),
          pushToken: expoPushToken
        });
        
        if (pendingInvite) {
            await updateDoc(doc(db, "clubs", pendingInvite.clubId), {
                members: arrayUnion({
                    name: name,
                    email: cleanEmail,
                    phone: phone,
                    miles: 0,
                    shareConsent: true,
                    muted: false
                })
            });
        }
        await AsyncStorage.setItem('hasSeenOnboarding', 'true');
        setHasSeenOnboarding(true);
      }}
    />
);
  return (
    <View style={styles.container}><LinearGradient colors={['#991b1b', '#000000', '#1e3a8a']} locations={[0, 0.5, 1]} style={styles.background} /><SafeAreaView style={{ flex: 1 }}>
        {currentScreen === 'Home' && <HomeScreen setCurrentScreen={setCurrentScreen} shoes={shoesWithMiles} userProfile={userProfile} monthlyMiles={monthlyMiles} onLogout={()=>signOut(auth)} />}
        {currentScreen === 'RunTracker' && <RunTrackerScreen setCurrentScreen={setCurrentScreen} onSaveRun={handleSaveRun} />}
     {currentScreen === 'Profile' && (
  <ProfileScreen 
    setCurrentScreen={setCurrentScreen} 
    userProfile={userProfile} 
    onUpdateUser={(d) => updateDoc(doc(db, "users", user.uid), d)} 
    onUploadPhoto={async (uri) => {
        const r = ref(storage, `p/${user.uid}`);
        await uploadBytes(r, await (await fetch(uri)).blob());
        updateDoc(doc(db, "users", user.uid), { photoURL: await getDownloadURL(r) })
    }} 
    onCancelSubscription={() => setCurrentScreen('Home')} 
  />
)}
        {currentScreen === 'Log' && <LogPage setCurrentScreen={setCurrentScreen} shoes={shoesWithMiles} onSaveRun={handleSaveRun} clubs={clubs} />}
        {currentScreen === 'History' && <HistoryScreen setCurrentScreen={setCurrentScreen} runs={runs} shoes={shoesWithMiles} clubs={clubs} onDeleteRun={(id)=>deleteDoc(doc(db,"runs",id))} onUpdateRun={(id, d)=>updateDoc(doc(db,"runs",id), d)} />}
        {currentScreen === 'ManageShoes' && <ManageShoesScreen setCurrentScreen={setCurrentScreen} shoes={shoesWithMiles} onAddShoe={(n)=>addDoc(collection(db,"shoes"),{userId:user.uid,name:n,initialMiles:0,limit:400,retired:false})} onDeleteShoe={(id)=>deleteDoc(doc(db,"shoes",id))} onUpdateShoeName={(id, n)=>updateDoc(doc(db, "shoes", id), { name: n })} />}
        {currentScreen === 'Clubs' && <ClubsScreen setCurrentScreen={setCurrentScreen} clubs={clubs} userProfile={userProfile} onUnlockFounder={()=>updateDoc(doc(db,"users",user.uid),{isFounder:true})} onSelectClub={(c)=>{setSelectedClub(c);setCurrentScreen('ClubDetail')}} />}
        {currentScreen === 'CreateClub' && <CreateClubScreen setCurrentScreen={setCurrentScreen} onLaunch={(n)=>{addDoc(collection(db,"clubs"),{name:n,admin:userProfile.fullName,adminId:user.uid,members:[{name:userProfile.fullName,email:user.email,phone:userProfile.phone||"",miles:0,shareConsent:true}],announcements:[],createdAt:new Date()});updateDoc(doc(db,"users",user.uid),{isFounder:true});setCurrentScreen('Clubs')}} />}
        {currentScreen === 'JoinClub' && <JoinClubScreen setCurrentScreen={setCurrentScreen} onJoin={async(id)=>{const r=doc(db,"clubs",id);const s=await getDoc(r);if(s.exists()){updateDoc(r,{members:arrayUnion({name:userProfile.fullName,email:user.email,phone:userProfile.phone,miles:0,shareConsent:true,muted:false})});setCurrentScreen('Clubs')}else{Alert.alert("Error","Invalid Code")}}} />}
        {currentScreen === 'ClubDetail' && <ClubDetailScreen setCurrentScreen={setCurrentScreen} club={selectedClub} isAdmin={selectedClub?.adminId===user?.uid} onDeleteClub={(id)=>deleteDoc(doc(db,"clubs",id))} onUpdateAnnouncement={(cid,aid,t,b)=>{const c=clubs.find(x=>x.id===cid);const u=c.announcements.map(a=>a.id===aid?{...a,title:t,body:b}:a);updateDoc(doc(db,"clubs",cid),{announcements:u})}} onRemoveMember={handleRemoveMember} onLeaveClub={handleLeaveClub} onInviteMember={handleInviteMember} userProfile={userProfile} onToggleMute={handleToggleMute} />}
        {currentScreen === 'AnnouncementComposer' && <AnnouncementComposer setCurrentScreen={setCurrentScreen} club={selectedClub} onPost={handlePostAnnouncement} />}
        {currentScreen === 'ClubChat' && <ClubChatScreen setCurrentScreen={setCurrentScreen} club={selectedClub} user={user} userProfile={userProfile} />}
        <Toast message={toastMessage} visible={showToast} onHide={() => setShowToast(false)} />
    </SafeAreaView></View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 }, background: { position: 'absolute', left: 0, right: 0, top: 0, bottom: 0 }, scrollContent: { padding: 24 },
  greeting: { fontSize: 36, fontWeight: '900', color: 'white', marginTop: 10 }, subGreeting: { fontSize: 18, color: 'rgba(255,255,255,0.5)', marginBottom: 10 },
  cardWrapper: { marginBottom: 20, shadowColor: '#000', shadowOpacity: 0.5, shadowRadius: 15 }, glass: { padding: 24, borderRadius: 28, borderWidth: 1, borderColor: 'rgba(255,255,255,0.15)', overflow: 'hidden' },
  buttonContainer: { flexDirection: 'row', gap: 12, marginTop: 10 }, mainActionButton: { backgroundColor: '#ef4444', paddingVertical: 18, borderRadius: 16, flex: 1, alignItems: 'center', justifyContent: 'center' }, secondaryActionButton: { backgroundColor: 'rgba(255,255,255,0.1)', paddingVertical: 18, borderRadius: 16, flex: 1, alignItems: 'center', justifyContent: 'center', borderWidth: 1, borderColor: 'rgba(255,255,255,0.2)' }, buttonText: { color: 'white', fontWeight: 'bold', fontSize: 16 },
  row: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }, backBtnText: { color: '#ef4444', fontWeight: 'bold' }, label: { color: 'white', fontSize: 10, fontWeight: '900', opacity: 0.4, marginTop: 20, marginBottom: 8 }, input: { backgroundColor: 'rgba(255,255,255,0.08)', padding: 18, borderRadius: 16, color: 'white', marginBottom: 5 },
  privacyRow: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 30, paddingTop: 30, borderTopWidth: 1, borderTopColor: 'rgba(255,255,255,0.1)' }, valueTitle: { color: 'white', fontSize: 17, fontWeight: '700' }, valueDesc: { color: 'rgba(255,255,255,0.4)', fontSize: 13 },
  milesTotal: { color: 'white', fontSize: 56, fontWeight: '900', marginVertical: 10 }, cardTitle: { color: 'white', fontSize: 12, fontWeight: '800', textTransform: 'uppercase', opacity: 0.6 },
  shoeName: { color: 'white', fontSize: 18, fontWeight: '700' }, shoeItem: { marginTop: 18 }, shoeMiles: { color: 'rgba(255,255,255,0.4)', fontSize: 12, marginTop: 5 },
  progressBarBase: { height: 8, backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: 4, marginTop: 8 }, progressBarFill: { height: '100%', borderRadius: 4 },
  profileIconBtn: { backgroundColor: 'rgba(255,255,255,0.1)', padding: 12, borderRadius: 20, borderWidth: 1, borderColor: 'rgba(255,255,255,0.2)' },
  manageLink: { color: '#ef4444', fontWeight: 'bold' }, onboardingContainer: { flex: 1, justifyContent: 'center' }, onboardingContent: { flex: 1, padding: 30, justifyContent: 'space-between' }, skipBtn: { position: 'absolute', top: 60, right: 30, zIndex: 10 }, skipText: { color: 'rgba(255,255,255,0.5)', fontWeight: 'bold' }, onboardingTitle: { fontSize: 42, fontWeight: '900', color: 'white', textAlign: 'center', marginBottom: 15 },onboardingBtn: { 
  backgroundColor: '#ef4444', 
  paddingVertical: 16, 
  paddingHorizontal: 40, 
  borderRadius: 25, 
  alignSelf: 'center', 
  marginTop: 20,
  alignItems: 'center' 
},
  logoutBtn: { marginTop: 40, marginBottom: 40, alignSelf: 'center', padding: 10 }, logoutText: { color: '#ef4444', fontWeight: 'bold', fontSize: 16 },
  toastContainer: { position: 'absolute', top: 50, left: 20, right: 20, alignItems: 'center', zIndex: 999 }, toastGlass: { paddingVertical: 12, paddingHorizontal: 24, borderRadius: 25, overflow: 'hidden', backgroundColor: 'rgba(20,20,20,0.8)' }, toastText: { color: '#4ade80', fontWeight: 'bold', fontSize: 14 },
  modalOverlay: { flex: 1, justifyContent: 'center', backgroundColor: 'rgba(0,0,0,0.85)', padding: 30 }, confirmModal: { padding: 30, borderRadius: 30, borderWidth: 1, borderColor: 'rgba(255,255,255,0.1)' }, modalTitle: { color: 'white', fontSize: 24, fontWeight: '900', marginBottom: 15, textAlign: 'center' },
  bottomSheetOverlay: { flex: 1, justifyContent: 'flex-end', backgroundColor: 'rgba(0,0,0,0.8)' }, bottomSheetContent: { padding: 30, borderTopLeftRadius: 40, borderTopRightRadius: 40, minHeight: 450 }, cancelButton: { backgroundColor: 'rgba(255,255,255,0.1)', paddingVertical: 16, borderRadius: 16, alignItems: 'center', marginTop: 10 },
  tabContainer: { flexDirection: 'row', backgroundColor: 'rgba(255,255,255,0.05)', borderRadius: 15, padding: 4, marginBottom: 20, marginTop: 15 }, tabBtn: { flex: 1, paddingVertical: 12, alignItems: 'center', borderRadius: 12 }, tabBtnActive: { backgroundColor: 'rgba(255,255,255,0.1)' }, tabText: { color: 'rgba(255,255,255,0.4)', fontWeight: 'bold', fontSize: 13 },
  clubItem: { paddingVertical: 15, borderBottomWidth: 1, borderBottomColor: 'rgba(255,255,255,0.1)' }, clubItemText: { color: 'white', fontSize: 16, fontWeight: 'bold' },
  filterRow: { flexDirection: 'row', justifyContent: 'center', marginBottom: 15, gap: 10 }, filterBtn: { paddingVertical: 8, paddingHorizontal: 16, borderRadius: 20, backgroundColor: 'rgba(255,255,255,0.1)' }, filterBtnActive: { backgroundColor: '#ef4444' },
  leaderboardItem: { flexDirection: 'row', justifyContent: 'space-between', paddingVertical: 15, borderBottomWidth: 1, borderBottomColor: 'rgba(255,255,255,0.1)' }, rankText: { fontSize: 20, marginRight: 15, color: 'white', width: 30 }, historyMiles: { color: 'white', fontSize: 20, fontWeight: '900' }, memberDirectoryItem: { paddingVertical: 15, borderBottomWidth: 1, borderBottomColor: 'rgba(255,255,255,0.1)', flexDirection: 'row', alignItems: 'center', justifyContent:'space-between' },
  kudosBtn: {flexDirection: 'row', backgroundColor: 'rgba(255,255,255,0.1)', alignSelf: 'flex-start', padding: 8, borderRadius: 15, marginTop: 10},
  joinCodeBtn: { backgroundColor: 'white', paddingVertical: 16, borderRadius: 16, alignItems: 'center', marginTop: 20, marginBottom: 10 }, joinCodeText: { color: '#3b82f6', fontWeight: 'bold', fontSize: 16 }
});